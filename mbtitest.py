import streamlit as st
import matplotlib
matplotlib.use('Agg')  # Streamlitì—ì„œ ë°±ì—”ë“œ ì„¤ì •
import matplotlib.pyplot as plt
from PIL import Image
import pandas as pd
import os

st.set_page_config(page_title="MBTI ì§„ë¡œ/ì§„í•™ ì¶”ì²œ", layout="wide")
st.title("ğŸ§  MBTI ê¸°ë°˜ ì§„ë¡œ/ì§„í•™ ë¶„ì„ í”„ë¡œê·¸ë¨")

# MBTI ì°¨ì› ì •ì˜
dimensions = ["E", "I", "S", "N", "T", "F", "J", "P"]
scores = {dim: 0 for dim in dimensions}

# ì°¨ì›ë³„ ì§ˆë¬¸
questions = {
    "E": [
        "ì‚¬ëŒë“¤ê³¼ ì–´ìš¸ë¦´ ë•Œ ì—ë„ˆì§€ê°€ ìƒê¸´ë‹¤",
        "ì—¬ëŸ¿ì´ ì–´ìš¸ë¦¬ëŠ” í™œë™ì„ ì„ í˜¸í•œë‹¤",
        "ìƒˆë¡œìš´ ì‚¬ëŒì„ ë§Œë‚˜ëŠ” ê²ƒì´ ì¦ê²ë‹¤",
        "ì¦‰í¥ì ì¸ ëŒ€í™”ë¥¼ ì˜ í•œë‹¤",
        "ìê¸°ì†Œê°œë¥¼ í¸í•˜ê²Œ í•œë‹¤",
        "ëª¨ì„ì„ ì£¼ë„í•˜ëŠ” í¸ì´ë‹¤",
        "ë‹¤ì–‘í•œ í™œë™ì— ìì£¼ ì°¸ì—¬í•œë‹¤"
    ],
    "I": [
        "í˜¼ì ìˆëŠ” ì‹œê°„ì´ í•„ìš”í•˜ë‹¤",
        "ì¡°ìš©í•œ í™˜ê²½ì´ ë” í¸í•˜ë‹¤",
        "ìƒê°ì„ ì •ë¦¬í•œ í›„ ë§í•œë‹¤",
        "ê°ì •ë³´ë‹¤ ê´€ì°°ì— ì§‘ì¤‘í•œë‹¤",
        "ìì‹ ë§Œì˜ ê³µê°„ì´ ì¤‘ìš”í•˜ë‹¤",
        "í˜¼ìì„œ ë¬¸ì œ í•´ê²°ì„ ì„ í˜¸í•œë‹¤",
        "ì‚¬êµì ì¸ ìë¦¬ëŠ” í”¼ë¡œí•˜ë‹¤"
    ],
    "S": [
        "í˜„ì‹¤ì ì´ê³  ì‹¤ìš©ì ì¸ ê²ƒì„ ì¢‹ì•„í•œë‹¤",
        "ì§€ê¸ˆ ìƒí™©ì— ì§‘ì¤‘í•˜ëŠ” í¸ì´ë‹¤",
        "ì‚¬ì‹¤ê³¼ ë°ì´í„°ë¥¼ ì¤‘ì‹œí•œë‹¤",
        "ê²½í—˜ì—ì„œ ë°°ìš°ëŠ” ê±¸ ì„ í˜¸í•œë‹¤",
        "ì„¸ë¶€ì‚¬í•­ì„ ì˜ ê¸°ì–µí•œë‹¤",
        "ëª…í™•í•˜ê³  êµ¬ì²´ì ì¸ ì„¤ëª…ì´ ì¢‹ë‹¤",
        "ì‹ ì¤‘í•œ ì„ íƒì„ í•œë‹¤"
    ],
    "N": [
        "ìƒìƒí•˜ê³  ì°½ì¡°í•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•œë‹¤",
        "ë¯¸ë˜ì˜ ê°€ëŠ¥ì„±ì— ìì£¼ ìƒê°ì´ ë¨¸ë¬¸ë‹¤",
        "ì€ìœ ì  í‘œí˜„ì„ ì¦ê¸´ë‹¤",
        "ì§ê´€ì— ë”°ë¼ ê²°ì •ì„ ë‚´ë¦°ë‹¤",
        "ìƒˆë¡œìš´ ì´ë¡ ì´ë‚˜ ê°œë…ì„ ì¦ê¸´ë‹¤",
        "ì „ì²´ íë¦„ì„ ë¹ ë¥´ê²Œ íŒŒì•…í•œë‹¤",
        "ë³€í™”ì— ì—´ë ¤ìˆë‹¤"
    ],
    "T": [
        "ë…¼ë¦¬ì™€ ë¶„ì„ì´ ì¤‘ìš”í•˜ë‹¤",
        "ë¬¸ì œë¥¼ í•´ê²°í•  ë•Œ ê°ì •ë³´ë‹¤ ì‚¬ì‹¤ì„ ë³¸ë‹¤",
        "ë¹„íŒì ìœ¼ë¡œ ì‚¬ê³ í•˜ëŠ” í¸ì´ë‹¤",
        "ê°ê´€ì ìœ¼ë¡œ íŒë‹¨í•˜ë ¤ í•œë‹¤",
        "íš¨ìœ¨ì„ ìš°ì„ ì‹œí•œë‹¤",
        "ê°ì •ë³´ë‹¤ëŠ” ì›ì¹™ì´ ìš°ì„ ì´ë‹¤",
        "ë…¼ìŸì„ í”¼í•˜ì§€ ì•ŠëŠ”ë‹¤"
    ],
    "F": [
        "ë‹¤ë¥¸ ì‚¬ëŒì˜ ê°ì •ì„ ì˜ ì´í•´í•œë‹¤",
        "ê³µê°í•˜ëŠ” ëŒ€í™”ê°€ ì¤‘ìš”í•˜ë‹¤",
        "ìƒëŒ€ì˜ ì…ì¥ì—ì„œ ìƒê°í•œë‹¤",
        "ì‚¬ëŒ ì‚¬ì´ì˜ ì¡°í™”ë¥¼ ì¤‘ì‹œí•œë‹¤",
        "ì •ì˜ë³´ë‹¤ ë°°ë ¤ê°€ ë” ì¤‘ìš”í•˜ë‹¤",
        "ìƒëŒ€ì˜ ê¸°ë¶„ì„ í•´ì¹˜ì§€ ì•Šìœ¼ë ¤ ë…¸ë ¥í•œë‹¤",
        "ë¶ˆí¸í•œ ë§ì„ í”¼í•˜ëŠ” í¸ì´ë‹¤"
    ],
    "J": [
        "ê³„íšì ìœ¼ë¡œ í–‰ë™í•˜ëŠ” í¸ì´ë‹¤",
        "ë§ˆê° ê¸°í•œì„ ì˜ ì§€í‚¨ë‹¤",
        "í•  ì¼ì„ ë¯¸ë¦¬ ì¤€ë¹„í•œë‹¤",
        "ì¼ì •í‘œë¥¼ ë§Œë“œëŠ” ê±¸ ì¢‹ì•„í•œë‹¤",
        "í˜¼ë€ìŠ¤ëŸ¬ìš´ ìƒí™©ì´ ì‹«ë‹¤",
        "ì²´ê³„ì ì¸ í™˜ê²½ì´ ì¢‹ë‹¤",
        "ë¶ˆí™•ì‹¤í•œ ìƒí™©ì— ë¶ˆí¸í•¨ì„ ëŠë‚€ë‹¤"
    ],
    "P": [
        "ì¦‰í¥ì ì¸ ê²°ì •ì„ ì˜ í•œë‹¤",
        "ìƒí™©ì— ë”°ë¼ ìœ ì—°í•˜ê²Œ ëŒ€ì²˜í•œë‹¤",
        "ìƒˆë¡œìš´ ì¼ì •ì„ ë°˜ê¸°ëŠ” í¸ì´ë‹¤",
        "ê¸°í•œì´ ê°€ê¹Œì›Œì•¼ ì§‘ì¤‘ì´ ëœë‹¤",
        "ë³€í™”ì— ê°•í•˜ë‹¤",
        "ê³„íšë³´ë‹¤ëŠ” íë¦„ì— ë§¡ê¸´ë‹¤",
        "ììœ ë¡œìš´ ìŠ¤íƒ€ì¼ì´ ì¢‹ë‹¤"
    ]
}

# ì§ˆë¬¸ ì¶œë ¥
st.subheader("ğŸ“ 56ë¬¸í•­ ì„±ê²© ìœ í˜• ì§ˆë¬¸")
for dim in dimensions:
    st.markdown(f"#### {'ì™¸í–¥' if dim == 'E' else 'ë‚´í–¥' if dim == 'I' else dim}")
    for i, q in enumerate(questions[dim]):
        ans = st.radio(q, ["ê·¸ë ‡ë‹¤", "ì•„ë‹ˆë‹¤"], key=f"{dim}_{i}")
        if ans == "ê·¸ë ‡ë‹¤":
            scores[dim] += 1

# ê²°ê³¼ ë¶„ì„
if st.button("ğŸ” ê²°ê³¼ ë¶„ì„ ë° ì¶”ì²œ ë³´ê¸°"):
    mbti = (
        "E" if scores["E"] >= scores["I"] else "I"
    ) + (
        "S" if scores["S"] >= scores["N"] else "N"
    ) + (
        "T" if scores["T"] >= scores["F"] else "F"
    ) + (
        "J" if scores["J"] >= scores["P"] else "P"
    )

    st.subheader(f"ğŸ¯ ë‹¹ì‹ ì˜ MBTI ìœ í˜•ì€: {mbti}")

    # MBTI ê²°ê³¼ ì •ë³´
    mbti_data = {
        "ENTP": {
            "ì„¤ëª…": "ë„ì „ì ì´ê³  ì°½ì˜ì ì¸ ë°œëª…ê°€í˜•",
            "ì§„ë¡œ": ["ì°½ì—…ê°€", "ë§ˆì¼€í„°", "ì „ëµê°€"],
            "ì „ê³µ": ["ê²½ì˜í•™", "ê²½ì œí•™", "ì°½ì—…í•™"]
        },
        "ISFJ": {
            "ì„¤ëª…": "ì„±ì‹¤í•˜ê³  ì˜¨í™”í•œ ì¡°ë ¥ìí˜•",
            "ì§„ë¡œ": ["ê°„í˜¸ì‚¬", "ì‚¬íšŒë³µì§€ì‚¬", "ì´ˆë“±êµì‚¬"],
            "ì „ê³µ": ["ê°„í˜¸í•™", "ì‚¬íšŒë³µì§€í•™", "êµìœ¡í•™"]
        },
        # ëª¨ë“  ìœ í˜• ì¶”ê°€ ê°€ëŠ¥...
    }

    info = mbti_data.get(mbti, None)
    if info:
        st.markdown(f"**ì„¤ëª…:** {info['ì„¤ëª…']}")
        st.markdown("**ğŸ’¼ ì¶”ì²œ ì§„ë¡œ:** " + ", ".join(info["ì§„ë¡œ"]))
        st.markdown("**ğŸ“ ì¶”ì²œ ì „ê³µ:** " + ", ".join(info["ì „ê³µ"]))
    else:
        st.warning("MBTI ë°ì´í„°ê°€ ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    # ì„±í–¥ ê·¸ë˜í”„ ì‹œê°í™”
    dim_pairs = [("E", "I"), ("S", "N"), ("T", "F"), ("J", "P")]
    labels = ["E-I", "S-N", "T-F", "J-P"]
    values = [scores[p1] - scores[p2] for p1, p2 in dim_pairs]

    fig, ax = plt.subplots()
    ax.bar(labels, values, color='cornflowerblue')
    ax.axhline(0, color='black')
    ax.set_ylabel("ì„±í–¥ ì ìˆ˜ ì°¨")
    ax.set_title("MBTI ì„±í–¥ ê·¸ë˜í”„")
    st.pyplot(fig)

    # ì €ì¥
    result = {
        "MBTI": mbti,
        **scores
    }
    df = pd.DataFrame([result])
    if not os.path.exists("mbti_results.csv"):
        df.to_csv("mbti_results.csv", index=False)
    else:
        df.to_csv("mbti_results.csv", mode='a', header=False, index=False)
    st.success("âœ… ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (mbti_results.csv)")
